<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Dasha Chart - Exact Calculations</title>
    <!-- Authentication Check -->
    <script>
        // Check authentication immediately on script load
        (function() {
            // Check if user is authenticated in localStorage
            const isAuthenticated = localStorage.getItem('ankjyotish_authenticated');
            const username = localStorage.getItem('ankjyotish_username');

            // If not authenticated, redirect to login immediately
            if (isAuthenticated !== 'true' || !username) {
                console.log('Not authenticated, redirecting to login');
                window.location.href = 'password.html?redirect=chart.html';
                return;
            }

            // Check subscription expiration if user data exists
            const userData = localStorage.getItem('ankjyotish_userdata');
            if (userData) {
                try {
                    const parsedUserData = JSON.parse(userData);
                    const now = new Date();
                    const expirationDate = new Date(parsedUserData.expiration);

                    if (now > expirationDate) {
                        console.log('Subscription expired, redirecting to login');
                        // Clear local data
                        localStorage.removeItem('ankjyotish_authenticated');
                        localStorage.removeItem('ankjyotish_username');
                        localStorage.removeItem('ankjyotish_userdata');
                        localStorage.removeItem('ankjyotish_loginTimestamp');
                        window.location.href = 'password.html?message=subscription_expired';
                        return;
                    }
                } catch (error) {
                    console.error('Error parsing user data:', error);
                    // If there's an error parsing user data, clear local and redirect
                    localStorage.removeItem('ankjyotish_authenticated');
                    localStorage.removeItem('ankjyotish_username');
                    localStorage.removeItem('ankjyotish_userdata');
                    localStorage.removeItem('ankjyotish_loginTimestamp');
                    window.location.href = 'password.html?redirect=chart.html';
                    return;
                }
            }

            // Authentication successful, continue loading the page
            console.log('Authenticated as:', username);
        })();
    </script>
    <style>
        :root {
            --primary-green: #2c5530;
            --mint-green: #e8f5e8;
            --light-mint: #f0f8f0;
            --text-dark: #333;
            --text-light: #666;
            --shadow: rgba(0, 0, 0, 0.1);
            --border: #d4e8d4;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: var(--text-dark);
            line-height: 1.6;
            padding-bottom: 60px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px var(--shadow);
        }

        .brand-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            gap: 10px;
        }

        .brand-logo {
            height: 80px;
            width: 80px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid var(--primary-green);
        }

        .brand-name {
            font-size: 2.5rem;
            font-weight: bold;
            color: var(--primary-green);
            margin: 0;
            text-decoration: none;
        }

        .brand-name:hover {
            color: var(--mint-green);
            text-decoration: underline;
        }

        .header h1 {
            color: var(--primary-green);
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: var(--text-light);
            font-size: 1.2em;
        }

        .input-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px var(--shadow);
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary-green);
        }

        .input-group input {
            padding: 12px;
            border: 2px solid var(--border);
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--primary-green);
        }

        .generate-btn {
            display: block;
            margin: 0 auto 100px;
            padding: 15px 40px;
            background: var(--primary-green);
            color: white;
            border: none;
            border-radius: 25px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px var(--shadow);
        }

        .generate-btn:hover:not(:disabled) {
            background: #1e3e21;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px var(--shadow);
        }

        .generate-btn:disabled {
            background: var(--text-light);
            cursor: not-allowed;
            transform: none;
        }

        .results-container {
            display: none;
            margin-top: 40px;
        }

        .chart-section {
            background: white;
            margin-bottom: 30px;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px var(--shadow);
        }

        .section-header {
            background: var(--mint-green);
            padding: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: var(--primary-green);
            font-size: 1.2em;
        }

        .timeline-scroll {
            display: flex;
            overflow-x: auto;
            padding: 20px;
            gap: 30px;
            scroll-behavior: smooth;
        }

        .timeline-panel {
            min-width: 450px;
            background: var(--light-mint);
            border: 2px solid var(--border);
            border-radius: 12px;
            padding: 20px 40px;
            max-width: fit-content;
            transition: transform 0.3s ease;
        }

        .timeline-panel:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px var(--shadow);
        }

        .panel-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .panel-number {
            font-size: 2em;
            font-weight: bold;
            color: var(--primary-green);
            margin-bottom: 5px;
        }

        .panel-dates {
            font-size: 0.9em;
            color: var(--text-light);
            margin-bottom: 10px;
        }

        .panel-details {
            font-size: 0.85em;
            color: var(--text-dark);
        }

        .basic-chart-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            max-width: 400px; /* Increased max width */
            margin: 20px auto;
            padding: 20px;
        }

        .grid-cell {
            width: 90px;
            height: 90px;
            border: 2px solid var(--mint-green);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            background: white;
            font-size: 24px;
            font-weight: bold;
            color: var(--primary-green);
            box-shadow: 0 2px 8px var(--shadow);
            transition: all 0.3s ease;
        }

        .grid-cell.active {
            background: var(--mint-green);
            color: var(--primary-green);
            transform: scale(1.05);
        }

        .collapsible-section {
            margin-bottom: 10px;
            border: 1px solid var(--mint-green);
            border-radius: 8px;
            overflow: hidden;
        }

        .collapsible-header {
            background: var(--mint-green);
            color: var(--primary-green);
            padding: 15px;
            cursor: pointer;
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapsible-content {
            display: none;
            padding: 15px;
            background: white;
            max-height: 600px;
            overflow-y: auto;
        }

        .collapsible-content.active {
            display: block;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
            font-size: 1.2em;
        }

        .error-message {
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            border-left: 4px solid #c62828;
        }

        .info-section {
            background: var(--light-mint);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .info-section h3 {
            color: var(--primary-green);
            margin-bottom: 10px;
        }

        .info-section p {
            color: var(--text-dark);
            margin-bottom: 5px;
        }

        @media (max-width: 768px) {
            .input-section {
                grid-template-columns: 1fr;
            }

            .timeline-panel {
                min-width: 300px;
            }

            .basic-chart-grid {
                max-width: 350px;
            }

            .grid-cell {
                width: 90px;
                height: 90px;
                font-size: 20px;
            }
        }

        /* Bottom Navigation Bar Styles */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.5);
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-around;
            padding: 7px 0;
            border-top: 1px solid rgba(77, 53, 53, 0.1);
            z-index: 1000;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-decoration: none;
            color: #9ca3af;
            font-size: 12px;
            transition: all 0.3s ease;
            padding: 8px 16px;
            border-radius: 8px;
        }

        .nav-item:hover,
        .nav-item.active {
            color: #0059ff;
            background: rgba(0, 255, 136, 0.1);
            box-shadow: 0 0 10px rgba(0, 255, 136, 0.5);
        }

        .nav-icon {
            width: 24px;
            height: 24px;
            margin-bottom: 4px;
            object-fit: contain;
        }

        .nav-item span {
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="brand-container">
                <img src="Ankjyotish logo.jpg" alt="AnkJyōtish Logo" class="brand-logo">
                <a href="index.html" class="brand-name" style="color: var(--primary-green); text-decoration: none;">AnkJyōtish</a>
            </div>
            <h1>Dasha Timeline</h1>
            <p>Powered by Sudhir K Narula</p>
        </div>

        <div class="input-section">
            <div class="input-group">
                <label for="userName">Full Name</label>
                <input type="text" id="userName" placeholder="Enter your full name" required>
            </div>
            
            <div class="input-group">
                <label for="birthDate">Date of Birth</label>
                <input type="date" id="birthDate" required>
            </div>
            
            <div class="input-group">
                <label for="anchorDate">Chart Start Date</label>
                <input type="date" id="anchorDate" required>
            </div>
        </div>

        <button class="generate-btn" onclick="generateChart()">Generate Chart</button>

        <div id="resultsContainer" class="results-container">
            <!-- Basic Chart Section -->
            <div class="chart-section">
                <div class="section-header">
                    <span>Basic Chart</span>
                </div>
                <div class="basic-chart-grid" id="basicChartGrid"></div>
                <div id="basicChartData" style="padding: 20px;"></div>
            </div>

            <!-- Mahadasha Section -->
            <div class="chart-section">
                <div class="section-header">
                    <span>Mahadasha Timeline (100 Years)</span>
                </div>
                <div class="timeline-scroll" id="mahadashaScroll"></div>
            </div>

            <!-- Antardasha Section -->
            <div class="chart-section">
                <div class="section-header">
                    <span>Antardasha Timeline (100 Years)</span>
                </div>
                <div class="timeline-scroll" id="antardashaScroll"></div>
            </div>

            <!-- Pratyantar Dasha Section -->
            <div class="chart-section">
                <div class="section-header">
                    <span>Pratyantar Dasha Timeline</span>
                </div>
                <div id="pratyantarScroll"></div>
            </div>
        </div>
        <p class="footer-note" style="margin-top: 2rem; text-align: center; font-size: 0.85rem; color: #4e4e4e;">© 2025 AnkJyōtish. All rights reserved.</p>
        <p class="footer-note" style="margin-top: 1rem; text-align: center; font-size: 0.85rem; color: #4e4e4e;">Powered by Sudhir K Narula</p>
    </div>

    <script>
        // === CONSISTENT MAHADASHA SYSTEM ===

        // Shared Helpers
        function reduce1to9(n) {
            let s = n;
            while (s > 9) s = String(s).split('').reduce((a, b) => a + Number(b), 0);
            return s === 0 ? 9 : s;
        }

        function daysBetweenInclusive(a, b) {
            const ms = (new Date(b.getFullYear(), b.getMonth(), b.getDate()) - 
                       new Date(a.getFullYear(), a.getMonth(), a.getDate()));
            return Math.floor(ms / 86400000) + 1;
        }

        function addYearsExact(d, years) {
            const out = new Date(d);
            out.setFullYear(out.getFullYear() + years);
            return out;
        }

        function addDays(d, days) {
            const out = new Date(d);
            out.setDate(out.getDate() + days);
            return out;
        }

        function isoWeekday(d) {
            const w = d.getDay();
            return w === 0 ? 7 : w;
        }

        // Planetary periods
        const planetaryPeriods = {
            1: 1,  // Sun - 1 year
            2: 2,  // Moon - 2 years
            3: 3,  // Jupiter - 3 years
            4: 4,  // Rahu - 4 years
            5: 5,  // Mercury - 5 years
            6: 6,  // Venus - 6 years
            7: 7,  // Ketu - 7 years
            8: 8,  // Saturn - 8 years
            9: 9   // Mars - 9 years
        };

        // Planet names
        const dashaNames = {
            1: 'Sun', 2: 'Moon', 3: 'Jupiter', 4: 'Rahu', 5: 'Mercury',
            6: 'Venus', 7: 'Ketu', 8: 'Saturn', 9: 'Mars'
        };

        // Mahadasha calculation
        function buildMahadashaTimeline(dob, anchorStart) {
            const timeline = [];
            let currentDasha = reduce1to9(dob.getDate());
            const hardStop = addYearsExact(anchorStart, 100);
            let start = new Date(dob);
            let currentYear = 0;

            while (start < hardStop) {
                const period = planetaryPeriods[currentDasha];
                let end = addYearsExact(start, period);
                end = addDays(end, -1);
                if (end >= hardStop) end = addDays(hardStop, -1);
                
                if (end >= anchorStart) {
                    timeline.push({ 
                        num: currentDasha, 
                        start, 
                        end,
                        name: dashaNames[currentDasha],
                        duration: period
                    });
                }
                
                start = addDays(end, 1);
                currentDasha = (currentDasha % 9) + 1;
                
                if (start > addYearsExact(anchorStart, 100)) break;
            }
            
            const relevantTimeline = timeline.filter(maha => 
                !(maha.end < anchorStart || maha.start > addYearsExact(anchorStart, 100))
            );
            
            return relevantTimeline;
        }

        // Antardasha calculation
        function antardashaNumber(dob, targetYear) {
            const day = dob.getDate();
            const month = dob.getMonth() + 1;

            const birthday = new Date(targetYear, dob.getMonth(), dob.getDate());

            const weekdayMap = {
                0: 1,  // Sunday
                1: 2,  // Monday
                2: 9,  // Tuesday
                3: 5,  // Wednesday
                4: 3,  // Thursday
                5: 6,  // Friday
                6: 8   // Saturday
            };
            const weekdayNo = weekdayMap[birthday.getDay()];

            const lastTwoTargetYear = targetYear % 100;

            const raw = day + month + weekdayNo + lastTwoTargetYear;
            return reduce1to9(raw);
        }

        function buildAntardashaTimeline(dob, anchorStart) {
            const out = [];
            const hardStop = addYearsExact(anchorStart, 100);
            let start = new Date(dob);
            
            while (start < hardStop) {
                let end = addYearsExact(start, 1);
                end = addDays(end, -1);
                if (end >= hardStop) end = addDays(hardStop, -1);
                
                const targetYear = start.getFullYear();
                const adNum = antardashaNumber(dob, targetYear);
                
                if (end >= anchorStart) {
                    out.push({ 
                        num: adNum, 
                        start, 
                        end,
                        name: dashaNames[adNum]
                    });
                }
                
                start = addDays(end, 1);
                
                if (start > addYearsExact(anchorStart, 100)) break;
            }
            
            const relevantTimeline = out.filter(ad => 
                !(ad.end < anchorStart || ad.start > addYearsExact(anchorStart, 100))
            );
            
            return relevantTimeline;
        }

        // Pratyantar calculation
        function getPratyantarDasha(antardasha, totalDays) {
            let sequence = [];
            let current = antardasha;
            let daysPassed = 0;

            while (daysPassed < totalDays) {
                let duration;
                if (current >= 1 && current <= 4) {
                    duration = current * 8;
                } else {
                    duration = (current * 8) + 1;
                }

                sequence.push({
                    number: current,
                    duration: duration,
                    startDay: daysPassed + 1,
                    endDay: daysPassed + duration
                });

                daysPassed += duration;
                current = (current % 9) + 1;
            }
            return sequence;
        }

        function expandPratyantarForAntardasha(adNum, adStart, adEnd) {
            const totalDays = daysBetweenInclusive(adStart, adEnd);
            const seq = getPratyantarDasha(adNum, totalDays);
            return seq.map(s => {
                const pStart = addDays(adStart, s.startDay - 1);
                let pEnd = addDays(adStart, s.endDay - 1);
                if (pEnd > adEnd) pEnd = adEnd;
                return { num: s.number, start: pStart, end: pEnd };
            });
        }

        // === RENDERING FUNCTIONS ===

        function formatDate(date) {
            return date.toLocaleDateString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function createBasicChart(dob) {
            const grid = document.getElementById('basicChartGrid');
            const data = document.getElementById('basicChartData');
            
            grid.innerHTML = '';
            data.innerHTML = '';

            const day = dob.getDate();
            const month = dob.getMonth() + 1;
            const fullYear = dob.getFullYear();
            const year = fullYear % 100;

            const yearDigits = String(fullYear).split('').reduce((a, b) => a + Number(b), 0);
            const destiny = reduce1to9(day + month + yearDigits);
            const basic = reduce1to9(day);

            const numberOccurrences = {
                1: [], 2: [], 3: [], 4: [], 5: [], 6: [], 7: [], 8: [], 9: []
            };

            const allDigits = [
                ...String(day).split('').map(Number),
                ...String(month).split('').map(Number),
                ...String(year).split('').map(Number),
                ...String(destiny).split('').map(Number)
            ];

            allDigits.forEach(digit => {
                if (digit >= 1 && digit <= 9) {
                    numberOccurrences[digit].push(digit);
                }
            });

            // Include basic only if day is not 1-9, 10, 20, 30
            if (![1,2,3,4,5,6,7,8,9,10,20,30].includes(day)) {
                numberOccurrences[basic].push(basic);
            }

            const mappingRule = {
                1: 2, 2: 7, 3: 1, 4: 9, 5: 6, 6: 4, 7: 5, 8: 8, 9: 3
            };

            const gridCells = new Array(9).fill('');

            for (let num = 1; num <= 9; num++) {
                const occurrences = numberOccurrences[num];
                if (occurrences.length > 0) {
                    const cellIndex = mappingRule[num] - 1;
                    gridCells[cellIndex] = occurrences.join('');
                }
            }

            gridCells.forEach(value => {
                const cell = document.createElement('div');
                cell.className = 'grid-cell' + (value ? ' active' : '');
                cell.textContent = value || '';
                grid.appendChild(cell);
            });

            data.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div><strong>Basic:</strong> ${basic}</div>
                    <div><strong>Destiny:</strong> ${destiny}</div>
                </div>
            `;
        }

        function createGridWithNumbers(dob, numbers) {
            const grid = document.createElement('div');
            grid.className = 'basic-chart-grid';
            grid.style.margin = '5px 0 5px 5px';
            grid.style.maxWidth = '200px';
            grid.style.position = 'relative';
            grid.style.top = 'auto';
            grid.style.left = 'auto';
            grid.style.transform = 'none';

            const day = dob.getDate();
            const month = dob.getMonth() + 1;
            const fullYear = dob.getFullYear();
            const year = fullYear % 100;
            const yearDigits = String(fullYear).split('').reduce((a, b) => a + Number(b), 0);
            const destiny = reduce1to9(day + month + yearDigits);
            const basic = reduce1to9(day);

            const numberOccurrences = {
                1: [], 2: [], 3: [], 4: [], 5: [], 6: [], 7: [], 8: [], 9: []
            };

            const allDigits = [
                ...String(day).split('').map(Number),
                ...String(month).split('').map(Number),
                ...String(year).split('').map(Number),
                ...String(destiny).split('').map(Number)
            ];

            // Include basic only if day is not 1-9, 10, 20, 30
            if (![1,2,3,4,5,6,7,8,9,10,20,30].includes(day)) {
                allDigits.push(...String(basic).split('').map(Number));
            }

            allDigits.forEach(digit => {
                if (digit >= 1 && digit <= 9) {
                    numberOccurrences[digit].push(digit);
                }
            });

            numbers.forEach(num => {
                if (num >= 1 && num <= 9) {
                    numberOccurrences[num].push(num);
                }
            });

            const mappingRule = {
                1: 2, 2: 7, 3: 1, 4: 9, 5: 6, 6: 4, 7: 5, 8: 8, 9: 3
            };

            const gridCells = new Array(9).fill('');

            for (let num = 1; num <= 9; num++) {
                const occurrences = numberOccurrences[num];
                if (occurrences.length > 0) {
                    const cellIndex = mappingRule[num] - 1;
                    gridCells[cellIndex] = occurrences.join('');
                }
            }

            gridCells.forEach(value => {
                const cell = document.createElement('div');
                cell.className = 'grid-cell' + (value ? ' active' : '');
                cell.style.width = '60px';
                cell.style.height = '60px';
                cell.style.fontSize = '16px';
                cell.textContent = value || '';
                grid.appendChild(cell);
            });

            return grid;
        }

        function createMahadashaPanels(mahadashas, dob) {
            const container = document.getElementById('mahadashaScroll');
            container.innerHTML = '';

            mahadashas.forEach(maha => {
                const panel = document.createElement('div');
                panel.className = 'timeline-panel';
                panel.style.position = 'relative';
                panel.style.minHeight = '180px';
                panel.innerHTML = `
                    <div class="panel-header">
                        <div class="panel-number">${maha.num}</div>
                        <div>Mahadasha</div>
                    </div>
                    <div class="panel-dates">${formatDate(maha.start)} - ${formatDate(maha.end)}</div>
                    <div class="panel-details">
                        Duration: ${maha.num} year${maha.num > 1 ? 's' : ''}
                    </div>
                `;

                const grid = createGridWithNumbers(dob, [maha.num]);
                grid.style.margin = '10px 0 0 0';
                panel.appendChild(grid);

                container.appendChild(panel);
            });


        }

        function createAntardashaPanels(antardashas, mahadashas, dob) {
            const container = document.getElementById('antardashaScroll');
            container.innerHTML = '';

            antardashas.forEach((ad, index) => {
                const coveringMaha = mahadashas.find(m =>
                    ad.start >= m.start && ad.start <= m.end
                );

                const panel = document.createElement('div');
                panel.className = 'timeline-panel';
                panel.style.position = 'relative';
                panel.style.minHeight = '180px';
                panel.innerHTML = `
                    <div class="panel-header">
                        <div class="panel-number">${ad.num}</div>
                        <div>Antardasha</div>
                    </div>
                    <div class="panel-dates">${formatDate(ad.start)} - ${formatDate(ad.end)}</div>
                    <div class="panel-details">
                        Year ${index + 1}<br>
                        Mahadasha: ${coveringMaha ? coveringMaha.num : 'N/A'}
                    </div>
                `;

                const numbers = [ad.num];
                if (coveringMaha) {
                    numbers.push(coveringMaha.num);
                }
                const grid = createGridWithNumbers(dob, numbers);
                grid.style.margin = '10px 0 0 0';
                panel.appendChild(grid);

                container.appendChild(panel);
            });

        }

        function createPratyantarCollapsible(antardashas, mahadashas, dob) {
            const container = document.getElementById('pratyantarScroll');
            container.innerHTML = '';

            const chunkSize = 10;
            let currentChunk = 0;

            function processChunk() {
                const startIdx = currentChunk * chunkSize;
                const endIdx = Math.min(startIdx + chunkSize, antardashas.length);

                for (let i = startIdx; i < endIdx; i++) {
                    const ad = antardashas[i];
                    const coveringMaha = mahadashas.find(m =>
                        ad.start >= m.start && ad.start <= m.end
                    );

                    const pratyantars = expandPratyantarForAntardasha(ad.num, ad.start, ad.end);

                    const section = document.createElement('div');
                    section.className = 'collapsible-section';

                    const header = document.createElement('div');
                    header.className = 'collapsible-header';
                    header.innerHTML = `
                        <span>Antardasha ${ad.num} (${formatDate(ad.start)} - ${formatDate(ad.end)})</span>
                        <span>▼</span>
                    `;

                    const content = document.createElement('div');
                    content.className = 'collapsible-content';

                    const scrollDiv = document.createElement('div');
                    scrollDiv.className = 'timeline-scroll';

                    pratyantars.forEach(prat => {
                        const panel = document.createElement('div');
                        panel.className = 'timeline-panel';
                        panel.style.position = 'relative';
                        panel.style.minWidth = '290px';
                        panel.innerHTML = `
                            <div class="panel-header">
                                <div class="panel-number">${prat.num}</div>
                                <div>Pratyantar</div>
                            </div>
                            <div class="panel-dates">${formatDate(prat.start)} - ${formatDate(prat.end)}</div>
                            <div class="panel-details">
                                MD: ${coveringMaha ? coveringMaha.num : 'N/A'}<br>
                                AD: ${ad.num}
                            </div>
                        `;

                        const numbers = [prat.num, ad.num];
                        if (coveringMaha) {
                            numbers.push(coveringMaha.num);
                        }
                        const grid = createGridWithNumbers(dob, numbers);
                        grid.style.margin = '10px 0 0 0';
                        panel.appendChild(grid);

                        scrollDiv.appendChild(panel);
                    });

                    content.appendChild(scrollDiv);
                    section.appendChild(header);
                    section.appendChild(content);
                    container.appendChild(section);

                    header.addEventListener('click', () => {
                        content.classList.toggle('active');
                        header.querySelector('span:last-child').textContent =
                            content.classList.contains('active') ? '▲' : '▼';
                    });
                }

                currentChunk++;
                if (currentChunk * chunkSize < antardashas.length) {
                    setTimeout(processChunk, 0);
                } else {
                    // Pratyantar count calculation completed
                }
            }

            processChunk();
        }

        // === MAIN GENERATION FUNCTION ===

        async function generateChart() {
            const name = document.getElementById('userName').value.trim();
            const birthDate = document.getElementById('birthDate').value;
            const anchorDate = document.getElementById('anchorDate').value;
            
            if (!name || !birthDate || !anchorDate) {
                alert('Please fill in all required fields.');
                return;
            }
            
            const dob = new Date(birthDate);
            const anchor = new Date(anchorDate);
            
            if (isNaN(dob.getTime()) || isNaN(anchor.getTime())) {
                alert('Please enter valid dates.');
                return;
            }
            
            const button = document.querySelector('.generate-btn');
            button.disabled = true;
            button.textContent = 'Generating...';
            
            setTimeout(() => {
                try {
                    const mahadashas = buildMahadashaTimeline(dob, anchor);
                    const antardashas = buildAntardashaTimeline(dob, anchor);
                    
                    createBasicChart(dob);
                    createMahadashaPanels(mahadashas, dob);
                    createAntardashaPanels(antardashas, mahadashas, dob);
                    createPratyantarCollapsible(antardashas, mahadashas, dob);
                    
                    document.getElementById('resultsContainer').style.display = 'block';
                    
                    document.getElementById('resultsContainer').scrollIntoView({ 
                        behavior: 'smooth' 
                    });
                    
                } catch (error) {
                    console.error('Error generating chart:', error);
                    alert('Error generating chart. Please check your inputs.');
                } finally {
                    button.disabled = false;
                    button.textContent = 'Generate Chart';
                }
            }, 100);
        }

        // Session Storage Functions
        function saveToSessionStorage() {
            const data = {
                userName: document.getElementById('userName').value,
                birthDate: document.getElementById('birthDate').value,
                anchorDate: document.getElementById('anchorDate').value
            };
            sessionStorage.setItem('chartData', JSON.stringify(data));
        }

        function loadFromSessionStorage() {
            // First try to load from main numerology data (from index.html)
            const mainData = sessionStorage.getItem('numerologyData');
            if (mainData) {
                const data = JSON.parse(mainData);
                document.getElementById('userName').value = data.fullName || '';
                document.getElementById('birthDate').value = data.birthDate || '';

                // Set today's date as default for anchor date
                const today = new Date();
                document.getElementById('anchorDate').value = today.toISOString().split('T')[0];

                // Auto-generate chart if name and DOB are available
                if (data.fullName && data.birthDate) {
                    setTimeout(() => {
                        generateChart();
                    }, 100);
                }
                return;
            }

            // Fallback to chart-specific data if main data not available
            const savedData = sessionStorage.getItem('chartData');
            if (savedData) {
                const data = JSON.parse(savedData);
                document.getElementById('userName').value = data.userName || '';
                document.getElementById('birthDate').value = data.birthDate || '';
                document.getElementById('anchorDate').value = data.anchorDate || '';

                // Auto-generate chart if all fields are filled
                if (data.userName && data.birthDate && data.anchorDate) {
                    setTimeout(() => {
                        generateChart();
                    }, 100);
                }
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date();
            document.getElementById('anchorDate').value = today.toISOString().split('T')[0];
            document.getElementById('resultsContainer').style.display = 'none';

            // Load saved data
            loadFromSessionStorage();

            // Add event listeners to save on input change
            document.getElementById('userName').addEventListener('input', saveToSessionStorage);
            document.getElementById('birthDate').addEventListener('input', saveToSessionStorage);
            document.getElementById('anchorDate').addEventListener('input', saveToSessionStorage);
        });
    </script>

    <!-- Bottom Navigation Bar -->
    <nav class="bottom-nav" id="bottomNav">
        <a href="index.html" class="nav-item" aria-label="Home">
            <img src="home.png" alt="Home" class="nav-icon">
            <span>Home</span>
        </a>
        <a href="name.html" class="nav-item" aria-label="Name">
            <img src="user.png" alt="Name" class="nav-icon">
            <span>Name</span>
        </a>
        <a href="mobile.html" class="nav-item" aria-label="Mobile">
            <img src="mobile-phone.png" alt="Mobile" class="nav-icon">
            <span>Mobile</span>
        </a>
        <a href="match.html" class="nav-item" aria-label="Match">
            <img src="couple.png" alt="Match" class="nav-icon">
            <span>Match</span>
        </a>
        <a href="chart.html" class="nav-item active" aria-label="Chart">
            <img src="calendar.png" alt="Chart" class="nav-icon">
            <span>Chart</span>
        </a>
    </nav>
</body>
</html>
